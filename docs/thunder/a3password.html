<!DOCTYPE html>
<html>

<head>
  <title>Thunder CTF</title>
  <link rel="stylesheet" type="text/css" href="../static/style.css">
  </link>
  <link href='https://fonts.googleapis.com/css?family=Nova+Square' rel='stylesheet' type='text/css'>
  </link>
  <link href='https://fonts.googleapis.com/css?family=Roboto:400,500,300' rel='stylesheet' type='text/css'>
  </link>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  </meta>
</head>

<body>
  <header class="banner" style="top: 5px">
    <div id="nav">
      <h1 style="margin-top:0px;">Thunder CTF</h1>
    </div>
  </header>
  <div class="level">
    <div style="padding-bottom:10px">
      <a class="levelbanner levelbutton" href="../..">&#8592</a>
      <h2 class="levelbanner">thunder/a3password</h2>
    </div>
  </div>
  <br>
  <div class=hints>
    <div>
      <span id="prev" class="hintbanner hintbutton buttondisabled">Prev</span>
      <span id="hint_title" class="hintbanner hintbannertext"></span>
      <span id="next" class="hintbanner hintbutton">Next</span>
    </div>
    <div id="hint_display" class="hintdisplay">
    </div>
    <div>
      <span id="writeup_button" class="hintbanner writeupbutton">Show Level Writeup</span>
    </div>
    <h3>Destroy:</h3>
    <pre>python3 thunder.py destroy</pre>
  </div>
  <footer class="bottombanner">Thunder CTF was created at Portland State University under NSF Award #1821841</footer>

  <ul id="hint_content" style="display: none">
    <li>
      <span>Intro</span>
      <h3>Setup:</h3>
      <p>Your virtual environment must be active to use thunder.py:</p>
      <pre>source ../env-tctf/bin/activate</pre>
      <pre>python3 thunder.py create thunder/a3password</pre>
      <p>Activate the service account given to you. You MUST do this, or the level will not work as intended.</p>
      <pre>gcloud auth activate-service-account --key-file=start/a3-access.json</pre>
      <h3>Intro:</h3>
      <p>In this level, the secret is hidden somewhere in the cloud infrastructure. Use the given compromised credentials to find it</p>
    </li>
    
    <li>
      <span>Hint 1</span>
      <p>Test the permissions of the given credentials using the test-permissions.py script.</p>
    </li>
    
    <li>
      <span>Hint 2</span>
      <p>The credentials have the permission cloudfunctions.functions.list</p>
    </li>
    
    <li>
      <span>Hint 3</span>
      <p>List the cloud functions in the project:</p>
      <pre>gcloud functions list</pre>
    </li>
    
    <li>
      <span>Hint 4</span>
      <p>Get more information about the function:</p>
      <pre>gcloud functions describe [function]</pre>
    </li>
    
    <li>
      <span>Hint 5</span>
      <p>Try calling the function:</p>
      <pre>curl [httpsTrigger]</pre>
    </li>
    
    <li>
      <span>Hint 6</span>
      <p>The function returned a 403 response, meaning you need to authenticate your request. Google's documentation for cloud function authentication can be found <a class="inline" href="https://cloud.google.com/functions/docs/securing/authenticating">here</a>.</p>
    </li>
    
    <li>
      <span>Hint 7</span>
      <p>To authenticate the request, we need to include an "identity" token (different than an "access" token) in the request.</p>
      <p>Generate an identity token for the service account:</p>
      <pre>gcloud auth print-identity-token</pre>
      <p>Call the function using the token:</p>
      <pre>curl [httpsTrigger] -H "Authorization: Bearer [identity-token]</pre>
      <p>Or, do this in one command:</p>
      <pre>curl [httpsTrigger] -H "Authorization: Bearer $(gcloud auth print-identity-token)"</pre>
    </li>
    
    <li>
      <span>Hint 8</span>
      <p>The function wants a "password" argument. Include it by adding "?password=[password]" to the end of the url.</p>
    </li>
    
    <li>
      <span>Hint 9</span>
      <p>The credentials you are using have the permission cloudfunctions.functions.sourceCodeGet. Use it to figure out what the function is doing.</p>
    </li>
    
    <li>
      <span>Hint 10</span>
      <p>Use the cloudfunctions REST API method projects.locations.functions.generateDownloadUrl to download the source code of the function.</p>
    </li>
    
    <li>
      <span>Hint 11</span>
      <p>Go to the REST reference <a class="inline" href="https://cloud.google.com/functions/docs/reference/rest/v1/projects.locations.functions/generateDownloadUrl">here</a>. This documentation describes how to make a request to the API to create a link to download the source code of a cloud function.</p>
      <p>In this case, you can use the "Try this API" feature on the right. Fill in the "name" field, formatting it as the documentation specifies. You will also need an access token, which is not the same as the identity token you generated earlier. To generate an access token, run:</p>
      <pre>gcloud auth print-access-token</pre>
      <p>In the "Try this API" window, click "show standard parameters," and paste the access token into the field "access token."</p>
      <img src="../img/a3password/tryapi1.png">
      <p>Leave the request body empty, and uncheck both "Google Oauth 2.0" and "API key," as we are using the access token for authentication. Click execute, and download the source code by curling or browsing the link given in the response.</p>
      <img src="../img/a3password/tryapi2.png">
    </li>
    
    <li>
      <span>Hint 12</span>
      <p>In main.py, we see in line 19 that the function expects XOR_PASSWORD, an environment variable, to be equal to the result of the bitwise xor of the entered password and XOR_FACTOR (password ^ XOR_FACTOR).</p>
    </li>
    
    <li>
      <span>Hint 13</span>
      <p>XOR_FACTOR is a constant in the code, and XOR_PASSWORD is an environment variable that can be found by running:</p>
      <pre>gcloud functions describe [function]</pre>
      <p>To find the password, compute the result of XOR_PASSWORD ^ XOR_FACTOR. Call the function, passing the correct password to the "password" argument.</p>
    </li>
    
  </ul>
  <div id="writeup_content" style="display: none">
    <p>Level writeup will be available soon</p>
  </div>

  <script src="https://code.jquery.com/jquery-1.11.3.min.js"></script>
  <script src="../static/slideshow.js"></script>
  <script src="../static/bannercollapse.js"></script>
  <script>$(".inline").attr("target","_blank")</script>
</body>

</html>